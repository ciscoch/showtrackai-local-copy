[build]
    command = "./netlify-build.sh"
    publish = "build/web"
    functions = "netlify/functions"

  [build.environment]
    # Flutter settings
    FLUTTER_VERSION = "3.19.0"
    FLUTTER_CHANNEL = "stable"

    # Build settings
    NODE_VERSION = "18"

    # Cache buster for forcing rebuilds
    CACHE_BUSTER = "v4-20250120-flutter-geolocation"

  # SPA routing for Flutter web
  [[redirects]]
    from = "/*"
    to = "/index.html"
    status = 200

  # Security headers
  [[headers]]
    for = "/*"
    [headers.values]
      X-Frame-Options = "DENY"
      X-XSS-Protection = "1; mode=block"
      X-Content-Type-Options = "nosniff"
      Referrer-Policy = "strict-origin-when-cross-origin"
      # Allow geolocation for the app itself
      Permissions-Policy = "camera=(), microphone=(), geolocation=(self)"

  # Cache static assets
  [[headers]]
    for = "/*.js"
    [headers.values]
      Cache-Control = "public, max-age=31536000, immutable"

  [[headers]]
    for = "/*.css"
    [headers.values]
      Cache-Control = "public, max-age=31536000, immutable"

  [[headers]]
    for = "/*.woff2"
    [headers.values]
      Cache-Control = "public, max-age=31536000, immutable"

  [[headers]]
    for = "/assets/*"
    [headers.values]
      Cache-Control = "public, max-age=31536000, immutable"

  # CORS for serverless functions
  [[headers]]
    for = "/.netlify/functions/*"
    [headers.values]
      Access-Control-Allow-Origin = "*"
      Access-Control-Allow-Headers = "Content-Type, Authorization"
      Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
