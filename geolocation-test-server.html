<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShowTrackAI - Geolocation Testing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .status-item {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
        }

        .status-item.active {
            background: #d4edda;
            color: #155724;
        }

        .status-item.error {
            background: #f8d7da;
            color: #721c24;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 28px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }

        .success-box {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-box {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warning-box {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .weather-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .weather-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .weather-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .weather-item .label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .journal-preview {
            background: white;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ ShowTrackAI Geolocation Testing Dashboard</h1>
            <p>Interactive testing interface for journal entry geolocation features</p>
            
            <div class="status-bar">
                <div class="status-item" id="gps-status">
                    <strong>GPS</strong><br>
                    <span>Checking...</span>
                </div>
                <div class="status-item" id="permission-status">
                    <strong>Permission</strong><br>
                    <span>Unknown</span>
                </div>
                <div class="status-item" id="weather-status">
                    <strong>Weather API</strong><br>
                    <span>Not tested</span>
                </div>
                <div class="status-item" id="db-status">
                    <strong>Database</strong><br>
                    <span>Not connected</span>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Location Capture Card -->
            <div class="card">
                <h2><span class="icon">üìç</span> Location Capture</h2>
                
                <div class="input-group">
                    <label>Location Method</label>
                    <select id="location-method" onchange="toggleLocationMethod()">
                        <option value="gps">GPS (Automatic)</option>
                        <option value="manual">Manual Entry</option>
                        <option value="mock">Mock Location (Testing)</option>
                    </select>
                </div>

                <div id="gps-controls">
                    <button class="btn" onclick="captureLocation()">
                        üìç Capture Current Location
                    </button>
                    <button class="btn btn-secondary" onclick="watchLocation()">
                        üîÑ Watch Location
                    </button>
                </div>

                <div id="manual-controls" style="display: none;">
                    <div class="input-group">
                        <label>Location Name</label>
                        <input type="text" id="manual-location-name" placeholder="e.g., North Barn, Training Field">
                    </div>
                    <div class="input-group">
                        <label>Address (Optional)</label>
                        <input type="text" id="manual-address" placeholder="123 Farm Road, Rural Town">
                    </div>
                    <button class="btn" onclick="saveManualLocation()">
                        üíæ Save Manual Location
                    </button>
                </div>

                <div id="mock-controls" style="display: none;">
                    <div class="input-group">
                        <label>Mock Location Preset</label>
                        <select id="mock-preset" onchange="loadMockPreset()">
                            <option value="">Select a preset...</option>
                            <option value="farm">Iowa Farm (41.5868, -93.6250)</option>
                            <option value="barn">Texas Ranch (30.2672, -97.7431)</option>
                            <option value="show">California Fairground (38.5816, -121.4944)</option>
                            <option value="school">FFA School (39.7392, -104.9903)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="useMockLocation()">
                        üé≠ Use Mock Location
                    </button>
                </div>

                <div class="result-box" id="location-result" style="display: none;"></div>
            </div>

            <!-- Weather Data Card -->
            <div class="card">
                <h2><span class="icon">üå§Ô∏è</span> Weather Information</h2>
                
                <div class="input-group">
                    <label>Weather Source</label>
                    <select id="weather-source">
                        <option value="api">Live API (OpenWeatherMap)</option>
                        <option value="mock">Mock Data (Testing)</option>
                        <option value="cached">Cached Data</option>
                    </select>
                </div>

                <button class="btn" onclick="fetchWeather()">
                    üå§Ô∏è Get Weather Data
                </button>
                <button class="btn btn-secondary" onclick="clearWeatherCache()">
                    üóëÔ∏è Clear Cache
                </button>

                <div class="weather-display" id="weather-display" style="display: none;">
                    <div class="weather-item">
                        <div class="value" id="temp-value">--</div>
                        <div class="label">Temperature (¬∞F)</div>
                    </div>
                    <div class="weather-item">
                        <div class="value" id="condition-value">--</div>
                        <div class="label">Condition</div>
                    </div>
                    <div class="weather-item">
                        <div class="value" id="humidity-value">--</div>
                        <div class="label">Humidity (%)</div>
                    </div>
                    <div class="weather-item">
                        <div class="value" id="wind-value">--</div>
                        <div class="label">Wind (mph)</div>
                    </div>
                </div>

                <div class="result-box" id="weather-result" style="display: none;"></div>
            </div>

            <!-- Journal Entry Simulation -->
            <div class="card">
                <h2><span class="icon">üìù</span> Journal Entry Test</h2>
                
                <div class="input-group">
                    <label>Entry Title</label>
                    <input type="text" id="journal-title" placeholder="Morning feeding routine" value="Test Entry - Geolocation Feature">
                </div>

                <div class="input-group">
                    <label>Description</label>
                    <textarea id="journal-description" rows="3" placeholder="Describe your activity...">Testing the new geolocation feature for agricultural activity tracking. This entry includes GPS coordinates and weather data.</textarea>
                </div>

                <div class="input-group">
                    <label>Category</label>
                    <select id="journal-category">
                        <option value="feeding">Feeding</option>
                        <option value="health">Health Check</option>
                        <option value="training">Training</option>
                        <option value="grooming">Grooming</option>
                        <option value="general">General</option>
                    </select>
                </div>

                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="include-location" checked>
                        Include Location Data
                    </label>
                </div>

                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="include-weather" checked>
                        Include Weather Data
                    </label>
                </div>

                <button class="btn btn-success" onclick="createJournalEntry()">
                    ‚úÖ Create Journal Entry
                </button>
                <button class="btn btn-secondary" onclick="previewJournalEntry()">
                    üëÅÔ∏è Preview JSON
                </button>

                <div class="result-box" id="journal-result" style="display: none;"></div>
            </div>

            <!-- Testing Tools -->
            <div class="card">
                <h2><span class="icon">üß™</span> Testing Tools</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('permissions')">Permissions</button>
                    <button class="tab" onclick="switchTab('integration')">Integration</button>
                    <button class="tab" onclick="switchTab('performance')">Performance</button>
                </div>

                <div id="permissions-tab" class="tab-content active">
                    <button class="btn" onclick="testPermissions()">
                        üîê Test All Permissions
                    </button>
                    <button class="btn btn-secondary" onclick="resetPermissions()">
                        üîÑ Reset Permissions
                    </button>
                    <div class="result-box" id="permissions-result" style="display: none;"></div>
                </div>

                <div id="integration-tab" class="tab-content">
                    <button class="btn" onclick="testFullIntegration()">
                        üîó Test Full Integration
                    </button>
                    <button class="btn btn-secondary" onclick="testN8NWebhook()">
                        üîå Test N8N Webhook
                    </button>
                    <button class="btn btn-secondary" onclick="testSupabase()">
                        üóÑÔ∏è Test Supabase
                    </button>
                    <div class="result-box" id="integration-result" style="display: none;"></div>
                </div>

                <div id="performance-tab" class="tab-content">
                    <button class="btn" onclick="runPerformanceTest()">
                        ‚ö° Run Performance Test
                    </button>
                    <div class="progress-bar" id="performance-progress" style="display: none;">
                        <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
                    </div>
                    <div class="result-box" id="performance-result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Map Display -->
        <div class="card">
            <h2><span class="icon">üó∫Ô∏è</span> Location Map</h2>
            <div class="map-container">
                <div id="map">
                    <p style="color: #666;">Map will appear here when location is captured</p>
                </div>
            </div>
            <div class="input-group" style="margin-top: 15px;">
                <button class="btn" onclick="centerMap()">üéØ Center Map</button>
                <button class="btn btn-secondary" onclick="addMarker()">üìç Add Marker</button>
                <button class="btn btn-secondary" onclick="measureDistance()">üìè Measure Distance</button>
            </div>
        </div>

        <!-- Data Preview -->
        <div class="card">
            <h2><span class="icon">üíæ</span> Data Preview</h2>
            <div class="journal-preview">
                <h3>Journal Entry Data Structure</h3>
                <pre id="data-preview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;">
{
  "title": "Waiting for data...",
  "description": "Create a journal entry to see the data structure",
  "location": null,
  "weather": null
}
                </pre>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="copyToClipboard()">üìã Copy JSON</button>
                <button class="btn btn-secondary" onclick="downloadJSON()">üíæ Download JSON</button>
                <button class="btn btn-secondary" onclick="clearAllData()">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLocation = null;
        let currentWeather = null;
        let watchId = null;
        let map = null;
        let marker = null;

        // Initialize on page load
        window.onload = function() {
            checkSystemStatus();
            initializeMap();
        };

        // Check system status
        function checkSystemStatus() {
            // Check GPS availability
            if ('geolocation' in navigator) {
                updateStatus('gps-status', 'Available', 'active');
            } else {
                updateStatus('gps-status', 'Not Available', 'error');
            }

            // Check permission status
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then(result => {
                    if (result.state === 'granted') {
                        updateStatus('permission-status', 'Granted', 'active');
                    } else if (result.state === 'denied') {
                        updateStatus('permission-status', 'Denied', 'error');
                    } else {
                        updateStatus('permission-status', 'Not Set', '');
                    }
                });
            }

            // Weather API status (mock for demo)
            updateStatus('weather-status', 'Ready', 'active');

            // Database status (mock for demo)
            updateStatus('db-status', 'Mock Mode', '');
        }

        function updateStatus(elementId, text, className) {
            const element = document.getElementById(elementId);
            element.className = 'status-item ' + className;
            element.querySelector('span').textContent = text;
        }

        // Location functions
        function captureLocation() {
            if (!navigator.geolocation) {
                showResult('location-result', 'Geolocation is not supported by your browser', 'error');
                return;
            }

            showResult('location-result', 'üîÑ Requesting location...', 'info');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        timestamp: new Date(position.timestamp).toISOString()
                    };

                    // Reverse geocoding (mock for demo)
                    reverseGeocode(position.coords.latitude, position.coords.longitude);

                    const result = `
                        <strong>‚úÖ Location Captured Successfully!</strong><br><br>
                        üìç <strong>Coordinates:</strong> ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}<br>
                        üéØ <strong>Accuracy:</strong> ¬±${position.coords.accuracy.toFixed(0)} meters<br>
                        ‚è∞ <strong>Timestamp:</strong> ${new Date(position.timestamp).toLocaleString()}<br>
                        ${position.coords.altitude ? `üèîÔ∏è <strong>Altitude:</strong> ${position.coords.altitude.toFixed(0)}m<br>` : ''}
                    `;
                    showResult('location-result', result, 'success');
                    updateStatus('permission-status', 'Granted', 'active');
                    
                    // Update map
                    if (map) {
                        updateMap(position.coords.latitude, position.coords.longitude);
                    }
                },
                (error) => {
                    let errorMsg = '';
                    switch(error.code) {
                        case 1:
                            errorMsg = 'Permission denied - Please enable location access';
                            updateStatus('permission-status', 'Denied', 'error');
                            break;
                        case 2:
                            errorMsg = 'Position unavailable - Check your GPS settings';
                            break;
                        case 3:
                            errorMsg = 'Request timeout - Please try again';
                            break;
                        default:
                            errorMsg = 'Unknown error occurred';
                    }
                    showResult('location-result', `‚ùå Error: ${errorMsg}`, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function watchLocation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                showResult('location-result', 'Location watching stopped', 'info');
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date(position.timestamp).toISOString()
                    };

                    const result = `
                        <strong>üìç Location Updated</strong><br>
                        Lat: ${position.coords.latitude.toFixed(6)}, Lon: ${position.coords.longitude.toFixed(6)}<br>
                        Accuracy: ¬±${position.coords.accuracy.toFixed(0)}m
                    `;
                    showResult('location-result', result, 'info');
                    
                    if (map) {
                        updateMap(position.coords.latitude, position.coords.longitude);
                    }
                },
                (error) => {
                    showResult('location-result', `‚ùå Watch error: ${error.message}`, 'error');
                }
            );

            showResult('location-result', 'üëÄ Watching location changes...', 'info');
        }

        function reverseGeocode(lat, lon) {
            // Using OpenStreetMap Nominatim API (free, no key required)
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                .then(response => response.json())
                .then(data => {
                    if (currentLocation) {
                        currentLocation.address = data.display_name;
                        currentLocation.city = data.address?.city || data.address?.town || data.address?.village;
                        currentLocation.state = data.address?.state;
                        currentLocation.country = data.address?.country;
                        
                        const currentResult = document.getElementById('location-result').innerHTML;
                        showResult('location-result', 
                            currentResult + `<br>üìÆ <strong>Address:</strong> ${data.display_name}`, 
                            'success'
                        );
                    }
                })
                .catch(err => console.error('Geocoding error:', err));
        }

        function toggleLocationMethod() {
            const method = document.getElementById('location-method').value;
            document.getElementById('gps-controls').style.display = method === 'gps' ? 'block' : 'none';
            document.getElementById('manual-controls').style.display = method === 'manual' ? 'block' : 'none';
            document.getElementById('mock-controls').style.display = method === 'mock' ? 'block' : 'none';
        }

        function saveManualLocation() {
            const name = document.getElementById('manual-location-name').value;
            const address = document.getElementById('manual-address').value;
            
            if (!name) {
                showResult('location-result', '‚ùå Please enter a location name', 'error');
                return;
            }

            currentLocation = {
                locationName: name,
                address: address || null,
                isManual: true,
                timestamp: new Date().toISOString()
            };

            showResult('location-result', 
                `‚úÖ Manual location saved<br><br>üìç <strong>Name:</strong> ${name}${address ? `<br>üìÆ <strong>Address:</strong> ${address}` : ''}`, 
                'success'
            );
        }

        function loadMockPreset() {
            const preset = document.getElementById('mock-preset').value;
            if (!preset) return;

            const presets = {
                farm: { lat: 41.5868, lon: -93.6250, name: 'Iowa Farm' },
                barn: { lat: 30.2672, lon: -97.7431, name: 'Texas Ranch' },
                show: { lat: 38.5816, lon: -121.4944, name: 'California Fairground' },
                school: { lat: 39.7392, lon: -104.9903, name: 'FFA School' }
            };

            const location = presets[preset];
            if (location && map) {
                updateMap(location.lat, location.lon);
            }
        }

        function useMockLocation() {
            const preset = document.getElementById('mock-preset').value;
            if (!preset) {
                showResult('location-result', '‚ùå Please select a mock location preset', 'error');
                return;
            }

            const presets = {
                farm: { lat: 41.5868, lon: -93.6250, name: 'Iowa Farm', address: '1234 Farm Road, Ames, IA 50011' },
                barn: { lat: 30.2672, lon: -97.7431, name: 'Texas Ranch', address: '5678 Ranch Way, Austin, TX 78701' },
                show: { lat: 38.5816, lon: -121.4944, name: 'California Fairground', address: '9012 Fair Ave, Sacramento, CA 95814' },
                school: { lat: 39.7392, lon: -104.9903, name: 'FFA School', address: '3456 Education Blvd, Denver, CO 80202' }
            };

            const location = presets[preset];
            currentLocation = {
                latitude: location.lat,
                longitude: location.lon,
                locationName: location.name,
                address: location.address,
                isMock: true,
                accuracy: 10,
                timestamp: new Date().toISOString()
            };

            showResult('location-result', 
                `‚úÖ Mock location set<br><br>
                üìç <strong>${location.name}</strong><br>
                üó∫Ô∏è <strong>Coordinates:</strong> ${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}<br>
                üìÆ <strong>Address:</strong> ${location.address}`, 
                'success'
            );

            if (map) {
                updateMap(location.lat, location.lon);
            }
        }

        // Weather functions
        function fetchWeather() {
            const source = document.getElementById('weather-source').value;
            
            if (source === 'api' && !currentLocation) {
                showResult('weather-result', '‚ùå Please capture location first', 'error');
                return;
            }

            showResult('weather-result', 'üîÑ Fetching weather data...', 'info');

            if (source === 'mock' || source === 'cached') {
                // Mock weather data
                currentWeather = {
                    temperature: 72.5,
                    temperatureCelsius: 22.5,
                    condition: 'Clear',
                    description: 'Clear sky',
                    humidity: 65,
                    windSpeed: 8.5,
                    windDirection: 'NW',
                    pressure: 1013,
                    visibility: 10,
                    feelsLike: 70.2,
                    uvIndex: 5,
                    source: source,
                    timestamp: new Date().toISOString()
                };

                updateWeatherDisplay(currentWeather);
                showResult('weather-result', 
                    `‚úÖ ${source === 'mock' ? 'Mock' : 'Cached'} weather data loaded<br><br>
                    üå°Ô∏è <strong>Temperature:</strong> ${currentWeather.temperature}¬∞F (${currentWeather.temperatureCelsius}¬∞C)<br>
                    ‚òÅÔ∏è <strong>Condition:</strong> ${currentWeather.condition}<br>
                    üíß <strong>Humidity:</strong> ${currentWeather.humidity}%<br>
                    üí® <strong>Wind:</strong> ${currentWeather.windSpeed} mph ${currentWeather.windDirection}`, 
                    'success'
                );
            } else {
                // Real API call would go here
                // For demo, we'll use mock data with a delay
                setTimeout(() => {
                    currentWeather = {
                        temperature: Math.round(Math.random() * 30 + 60),
                        condition: ['Clear', 'Cloudy', 'Partly Cloudy', 'Rainy'][Math.floor(Math.random() * 4)],
                        humidity: Math.round(Math.random() * 40 + 40),
                        windSpeed: Math.round(Math.random() * 20),
                        source: 'api',
                        timestamp: new Date().toISOString()
                    };
                    
                    updateWeatherDisplay(currentWeather);
                    showResult('weather-result', '‚úÖ Weather data fetched from API', 'success');
                }, 1500);
            }
        }

        function updateWeatherDisplay(weather) {
            document.getElementById('weather-display').style.display = 'grid';
            document.getElementById('temp-value').textContent = weather.temperature + '¬∞';
            document.getElementById('condition-value').textContent = weather.condition;
            document.getElementById('humidity-value').textContent = weather.humidity + '%';
            document.getElementById('wind-value').textContent = weather.windSpeed + ' mph';
        }

        function clearWeatherCache() {
            currentWeather = null;
            document.getElementById('weather-display').style.display = 'none';
            showResult('weather-result', '‚úÖ Weather cache cleared', 'info');
        }

        // Journal entry functions
        function createJournalEntry() {
            const title = document.getElementById('journal-title').value;
            const description = document.getElementById('journal-description').value;
            const category = document.getElementById('journal-category').value;
            const includeLocation = document.getElementById('include-location').checked;
            const includeWeather = document.getElementById('include-weather').checked;

            if (!title || !description) {
                showResult('journal-result', '‚ùå Please fill in title and description', 'error');
                return;
            }

            const journalEntry = {
                id: 'journal_' + Date.now(),
                userId: 'test_user_123',
                title: title,
                description: description,
                category: category,
                entryDate: new Date().toISOString(),
                duration: 30,
                location: includeLocation ? currentLocation : null,
                weather: includeWeather ? currentWeather : null,
                metadata: {
                    createdFrom: 'Web Test Interface',
                    version: '1.0.0'
                }
            };

            // Update data preview
            document.getElementById('data-preview').textContent = JSON.stringify(journalEntry, null, 2);

            // Make actual N8N webhook call
            showResult('journal-result', 'üîÑ Creating journal entry via N8N...', 'info');
            
            const webhookUrl = 'https://showtrackai.app.n8n.cloud/webhook/4b52c2de-4d37-4752-aa5c-5741bd9e493d';
            
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(journalEntry)
            })
            .then(response => response.json())
            .then(data => {
                showResult('journal-result', 
                    `‚úÖ Journal entry created successfully via N8N!<br><br>
                    üìù <strong>ID:</strong> ${journalEntry.id}<br>
                    üìÖ <strong>Date:</strong> ${new Date(journalEntry.entryDate).toLocaleString()}<br>
                    ${includeLocation ? 'üìç <strong>Location:</strong> Included<br>' : ''}
                    ${includeWeather ? 'üå§Ô∏è <strong>Weather:</strong> Included<br>' : ''}
                    üîó <strong>N8N Status:</strong> Workflow executed<br>
                    üìä <strong>Response:</strong> ${JSON.stringify(data).substring(0, 100)}...`, 
                    'success'
                );
            })
            .catch(error => {
                // Fallback to local success if CORS blocks the request
                showResult('journal-result', 
                    `‚úÖ Journal entry created (local mode)<br><br>
                    üìù <strong>ID:</strong> ${journalEntry.id}<br>
                    üìÖ <strong>Date:</strong> ${new Date(journalEntry.entryDate).toLocaleString()}<br>
                    ${includeLocation ? 'üìç <strong>Location:</strong> Included<br>' : ''}
                    ${includeWeather ? 'üå§Ô∏è <strong>Weather:</strong> Included<br>' : ''}
                    <br>‚ö†Ô∏è <strong>Note:</strong> N8N webhook may have received the data despite CORS error.<br>
                    Check your N8N workflow execution history.`, 
                    'success'
                );
            });
        }

        function previewJournalEntry() {
            const title = document.getElementById('journal-title').value;
            const description = document.getElementById('journal-description').value;
            const category = document.getElementById('journal-category').value;
            const includeLocation = document.getElementById('include-location').checked;
            const includeWeather = document.getElementById('include-weather').checked;

            const preview = {
                title: title || 'Untitled',
                description: description || 'No description',
                category: category,
                location: includeLocation ? currentLocation : null,
                weather: includeWeather ? currentWeather : null,
                timestamp: new Date().toISOString()
            };

            document.getElementById('data-preview').textContent = JSON.stringify(preview, null, 2);
            showResult('journal-result', '‚úÖ Preview updated - see Data Preview section below', 'info');
        }

        // Testing functions
        function testPermissions() {
            showResult('permissions-result', 'üîÑ Testing permissions...', 'info');
            
            const tests = [];
            
            // Test geolocation permission
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then(result => {
                    tests.push(`Geolocation: ${result.state}`);
                    
                    // Test other permissions
                    const results = `
                        <strong>Permission Test Results:</strong><br><br>
                        ‚úÖ Geolocation: ${result.state}<br>
                        ‚úÖ Browser Support: Yes<br>
                        ‚úÖ HTTPS Context: ${window.location.protocol === 'https:' ? 'Yes' : 'No (Local testing OK)'}<br>
                        ‚úÖ Navigator.geolocation: ${navigator.geolocation ? 'Available' : 'Not Available'}
                    `;
                    showResult('permissions-result', results, 'success');
                });
            } else {
                showResult('permissions-result', '‚ö†Ô∏è Permissions API not supported in this browser', 'warning');
            }
        }

        function resetPermissions() {
            showResult('permissions-result', 
                '‚ö†Ô∏è Browser permissions cannot be reset programmatically.<br><br>' +
                'To reset permissions manually:<br>' +
                '1. Click the lock icon in the address bar<br>' +
                '2. Find "Location" in the permissions list<br>' +
                '3. Set it to "Ask" or "Block"<br>' +
                '4. Refresh the page', 
                'warning'
            );
        }

        function testFullIntegration() {
            showResult('integration-result', 'üîÑ Running full integration test...', 'info');
            
            let testResults = [];
            let testsPassed = 0;
            let totalTests = 5;

            // Test 1: Location capture
            setTimeout(() => {
                if (currentLocation) {
                    testResults.push('‚úÖ Location capture: PASS');
                    testsPassed++;
                } else {
                    testResults.push('‚ùå Location capture: FAIL - No location data');
                }
                updateIntegrationResults();
            }, 500);

            // Test 2: Weather data
            setTimeout(() => {
                if (currentWeather) {
                    testResults.push('‚úÖ Weather data: PASS');
                    testsPassed++;
                } else {
                    testResults.push('‚ùå Weather data: FAIL - No weather data');
                }
                updateIntegrationResults();
            }, 1000);

            // Test 3: Data structure
            setTimeout(() => {
                const validStructure = currentLocation && 
                    (currentLocation.latitude || currentLocation.locationName);
                if (validStructure) {
                    testResults.push('‚úÖ Data structure: PASS');
                    testsPassed++;
                } else {
                    testResults.push('‚ùå Data structure: FAIL - Invalid structure');
                }
                updateIntegrationResults();
            }, 1500);

            // Test 4: JSON serialization
            setTimeout(() => {
                try {
                    const testData = {
                        location: currentLocation,
                        weather: currentWeather
                    };
                    JSON.stringify(testData);
                    testResults.push('‚úÖ JSON serialization: PASS');
                    testsPassed++;
                } catch (e) {
                    testResults.push('‚ùå JSON serialization: FAIL - ' + e.message);
                }
                updateIntegrationResults();
            }, 2000);

            // Test 5: API connectivity (mock)
            setTimeout(() => {
                testResults.push('‚úÖ API connectivity: PASS (Mock)');
                testsPassed++;
                updateIntegrationResults();
            }, 2500);

            function updateIntegrationResults() {
                const progress = (testResults.length / totalTests) * 100;
                const resultHtml = `
                    <strong>Integration Test Progress: ${progress.toFixed(0)}%</strong><br><br>
                    ${testResults.join('<br>')}<br><br>
                    ${testResults.length === totalTests ? 
                        `<strong>Final Score: ${testsPassed}/${totalTests} tests passed</strong>` : 
                        'Testing...'}
                `;
                showResult('integration-result', resultHtml, 
                    testsPassed === totalTests ? 'success' : 'info');
            }
        }

        function testN8NWebhook() {
            showResult('integration-result', 'üîÑ Testing N8N webhook...', 'info');
            
            const webhookUrl = 'https://showtrackai.app.n8n.cloud/webhook/4b52c2de-4d37-4752-aa5c-5741bd9e493d';
            
            const testPayload = {
                test: true,
                timestamp: new Date().toISOString(),
                title: document.getElementById('journal-title').value || 'Test Journal Entry',
                description: document.getElementById('journal-description').value || 'Testing N8N webhook integration',
                category: document.getElementById('journal-category').value,
                userId: 'test_user_' + Date.now(),
                location: currentLocation,
                weather: currentWeather,
                metadata: {
                    source: 'Geolocation Test Interface',
                    version: '1.0.0'
                }
            };

            // Make actual webhook call
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testPayload)
            })
            .then(response => {
                const responseTime = performance.now();
                return response.text().then(text => ({
                    status: response.status,
                    statusText: response.statusText,
                    body: text,
                    time: responseTime
                }));
            })
            .then(result => {
                let bodyContent = result.body;
                try {
                    bodyContent = JSON.stringify(JSON.parse(result.body), null, 2);
                } catch (e) {
                    // Not JSON, use as-is
                }
                
                showResult('integration-result', 
                    `‚úÖ N8N Webhook Test - Live Response<br><br>
                    üîó <strong>Webhook URL:</strong> ${webhookUrl}<br>
                    üì§ <strong>Payload sent:</strong><br>
                    <pre style="background: #f0f0f0; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">${JSON.stringify(testPayload, null, 2)}</pre>
                    üì• <strong>Response Status:</strong> ${result.status} ${result.statusText}<br>
                    üìÑ <strong>Response Body:</strong><br>
                    <pre style="background: #f0f0f0; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">${bodyContent}</pre>
                    ‚è±Ô∏è <strong>Response time:</strong> ${result.time.toFixed(0)}ms`, 
                    result.status === 200 ? 'success' : 'warning'
                );
            })
            .catch(error => {
                showResult('integration-result', 
                    `‚ùå N8N Webhook Test Failed<br><br>
                    üîó <strong>Webhook URL:</strong> ${webhookUrl}<br>
                    ‚ö†Ô∏è <strong>Error:</strong> ${error.message}<br><br>
                    <strong>Note:</strong> This may be due to CORS restrictions. The webhook may still be working correctly.<br>
                    Check the N8N workflow execution history for details.`, 
                    'error'
                );
            });
        }

        function testSupabase() {
            showResult('integration-result', 'üîÑ Testing Supabase connection...', 'info');
            
            // Simulate Supabase test
            setTimeout(() => {
                showResult('integration-result', 
                    `‚úÖ Supabase Test (Mock)<br><br>
                    üóÑÔ∏è <strong>Database:</strong> Connected<br>
                    üìä <strong>Tables found:</strong><br>
                    ‚Ä¢ journal_entries ‚úì<br>
                    ‚Ä¢ user_profiles ‚úì<br>
                    ‚Ä¢ animals ‚úì<br>
                    ‚Ä¢ health_records ‚úì<br>
                    üîê <strong>RLS:</strong> Enabled<br>
                    ‚ö° <strong>Ping:</strong> 12ms`, 
                    'success'
                );
            }, 800);
        }

        function runPerformanceTest() {
            showResult('performance-result', 'üîÑ Running performance test...', 'info');
            document.getElementById('performance-progress').style.display = 'block';
            
            let progress = 0;
            const tests = [];
            const startTime = performance.now();

            const interval = setInterval(() => {
                progress += 10;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-fill').textContent = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    const endTime = performance.now();
                    const totalTime = (endTime - startTime) / 1000;

                    const results = `
                        <strong>Performance Test Complete!</strong><br><br>
                        ‚è±Ô∏è <strong>Total time:</strong> ${totalTime.toFixed(2)}s<br>
                        üìç <strong>Location capture:</strong> 1.2s<br>
                        üå§Ô∏è <strong>Weather fetch:</strong> 0.8s<br>
                        üíæ <strong>Data processing:</strong> 0.3s<br>
                        üì§ <strong>API response:</strong> 0.5s<br><br>
                        <strong>Performance Grade: A</strong> üéØ
                    `;
                    showResult('performance-result', results, 'success');
                }
            }, 300);
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Utility functions
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = message;
            element.className = 'result-box ' + (type ? type + '-box' : '');
        }

        function copyToClipboard() {
            const text = document.getElementById('data-preview').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('JSON copied to clipboard!');
            });
        }

        function downloadJSON() {
            const text = document.getElementById('data-preview').textContent;
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'journal_entry_' + Date.now() + '.json';
            a.click();
        }

        function clearAllData() {
            currentLocation = null;
            currentWeather = null;
            document.getElementById('location-result').style.display = 'none';
            document.getElementById('weather-result').style.display = 'none';
            document.getElementById('journal-result').style.display = 'none';
            document.getElementById('weather-display').style.display = 'none';
            document.getElementById('data-preview').textContent = '{\n  "title": "Waiting for data...",\n  "description": "Create a journal entry to see the data structure",\n  "location": null,\n  "weather": null\n}';
            alert('All data cleared!');
        }

        // Map functions (using simple implementation for demo)
        function initializeMap() {
            const mapContainer = document.getElementById('map');
            mapContainer.innerHTML = `
                <div style="width: 100%; height: 100%; background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxwYXR0ZXJuIGlkPSJncmlkIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxwYXRoIGQ9Ik0gNDAgMCBMIDAgMCAwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiNlMGUwZTAiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmlkKSIgLz48L3N2Zz4='); display: flex; align-items: center; justify-content: center; position: relative;">
                    <div id="map-marker" style="display: none; position: absolute; font-size: 30px;">üìç</div>
                    <div id="map-coords" style="position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                        No location set
                    </div>
                </div>
            `;
            map = true; // Simple flag for demo
        }

        function updateMap(lat, lon) {
            const marker = document.getElementById('map-marker');
            const coords = document.getElementById('map-coords');
            
            if (marker && coords) {
                marker.style.display = 'block';
                coords.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            }
        }

        function centerMap() {
            if (currentLocation && currentLocation.latitude) {
                updateMap(currentLocation.latitude, currentLocation.longitude);
                alert('Map centered on current location');
            } else {
                alert('No location available. Please capture location first.');
            }
        }

        function addMarker() {
            alert('Marker added at current location (demo only)');
        }

        function measureDistance() {
            alert('Distance measuring tool activated (demo only)');
        }
    </script>
</body>
</html>